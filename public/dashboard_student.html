<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - SMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/output.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Student Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-gray-700"></span>
                    <button id="logoutBtn" class="btn btn-secondary">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Welcome Section -->
        <div class="px-4 py-6 sm:px-0">
            <div class="mb-6">
                <h2 id="welcomeMessage" class="text-2xl font-bold text-gray-900 mb-2"></h2>
                <p class="text-gray-600">Here's an overview of your academic progress</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Courses</p>
                            <p id="totalCourses" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Assignments</p>
                            <p id="totalAssignments" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Submitted</p>
                            <p id="submittedAssignments" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Average Grade</p>
                            <p id="averageGrade" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Assignments -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Recent Assignments</h3>
                        <button id="viewAllAssignments" class="text-primary-600 hover:text-primary-500 text-sm font-medium">View All</button>
                    </div>
                    <div id="recentAssignments">
                        <!-- Loading placeholder -->
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="card">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Performance Overview</h3>
                    <div class="relative h-64">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Enrolled Courses -->
                <div class="card">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Enrolled Courses</h3>
                    <div id="enrolledCourses">
                        <!-- Loading placeholder -->
                    </div>
                </div>

                <!-- ML Insights -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Performance Insights</h3>
                        <button id="refreshInsights" class="btn btn-secondary text-sm">Refresh</button>
                    </div>
                    <div id="mlInsights">
                        <!-- Loading placeholder -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!authManager.requireAuth('student')) {
                return;
            }

            const user = authManager.getCurrentUser();
            
            // Set user info
            document.getElementById('userName').textContent = `${user.first_name} ${user.last_name}`;
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.first_name}!`;

            // Set up logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                authManager.logout();
            });

            // Load dashboard data
            await loadDashboardData();

            // Set up refresh button
            document.getElementById('refreshInsights').addEventListener('click', loadMLInsights);
        });

        async function loadDashboardData() {
            try {
                // Show loading states
                utils.showLoading(document.getElementById('recentAssignments'));
                utils.showLoading(document.getElementById('enrolledCourses'));
                utils.showLoading(document.getElementById('mlInsights'));

                // Load dashboard data
                const dashboardData = await apiClient.get('/dashboard/student');
                
                // Update stats
                updateStats(dashboardData.stats);
                
                // Load recent assignments
                renderRecentAssignments(dashboardData.recent_assignments);
                
                // Load enrolled courses
                renderEnrolledCourses(dashboardData.courses);
                
                // Load performance chart
                renderPerformanceChart(dashboardData.grades);
                
                // Load ML insights
                await loadMLInsights();

            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                utils.showError(document.getElementById('recentAssignments'), 'Failed to load assignments');
                utils.showError(document.getElementById('enrolledCourses'), 'Failed to load courses');
                utils.showError(document.getElementById('mlInsights'), 'Failed to load insights');
            }
        }

        function updateStats(stats) {
            document.getElementById('totalCourses').textContent = stats.total_courses;
            document.getElementById('totalAssignments').textContent = stats.total_assignments;
            document.getElementById('submittedAssignments').textContent = stats.submitted_assignments;
            document.getElementById('averageGrade').textContent = stats.average_grade ? `${stats.average_grade}%` : 'N/A';
        }

        function renderRecentAssignments(assignments) {
            const container = document.getElementById('recentAssignments');
            
            if (!assignments || assignments.length === 0) {
                utils.showEmpty(container, 'No recent assignments');
                return;
            }

            container.innerHTML = assignments.map(assignment => `
                <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${assignment.title}</h4>
                            <p class="text-sm text-gray-600">${assignment.course_name}</p>
                            <p class="text-sm text-gray-500">Due: ${utils.formatDate(assignment.due_date)}</p>
                        </div>
                        <span class="text-sm font-medium text-gray-900">
                            ${assignment.max_score} pts
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderEnrolledCourses(courses) {
            const container = document.getElementById('enrolledCourses');
            
            if (!courses || courses.length === 0) {
                utils.showEmpty(container, 'Not enrolled in any courses');
                return;
            }

            container.innerHTML = courses.map(course => `
                <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${course.name}</h4>
                            <p class="text-sm text-gray-600">${course.code}</p>
                            <p class="text-sm text-gray-500">Instructor: ${course.teacher_name}</p>
                        </div>
                        <span class="text-sm font-medium text-gray-600">
                            ${course.credits} credits
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderPerformanceChart(grades) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (!grades || grades.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No grade data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            // Process grades data for chart
            const gradeData = grades.map((grade, index) => ({
                x: index + 1,
                y: (grade.score / 100) * 100 // Assuming max score of 100 for percentage
            }));

            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Performance',
                        data: gradeData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Assignment Number'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        async function loadMLInsights() {
            const container = document.getElementById('mlInsights');
            utils.showLoading(container);

            try {
                const user = authManager.getCurrentUser();
                const insights = await apiClient.get(`/ml/predict/${user.id}`);
                
                renderMLInsights(insights.insights);
            } catch (error) {
                console.error('Failed to load ML insights:', error);
                utils.showError(container, 'Unable to generate insights - insufficient data');
            }
        }

        function renderMLInsights(insights) {
            const container = document.getElementById('mlInsights');
            
            if (!insights) {
                utils.showError(container, 'No insights available');
                return;
            }

            const prediction = insights.prediction;
            const insightMessages = insights.insights || [];
            const recommendations = insights.recommendations || [];

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-md">
                        <h4 class="font-medium text-blue-900 mb-2">Predicted Performance</h4>
                        <p class="text-2xl font-bold text-blue-600">${prediction.predicted_performance}%</p>
                        <p class="text-sm text-blue-700">Current: ${prediction.current_performance.toFixed(2)}%</p>
                    </div>
                    
                    ${insightMessages.length > 0 ? `
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Insights</h4>
                            ${insightMessages.map(insight => `
                                <div class="alert alert-${insight.type === 'positive' ? 'success' : insight.type === 'warning' ? 'warning' : 'neutral'} mb-2">
                                    ${insight.message}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${recommendations.length > 0 ? `
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Recommendations</h4>
                            <ul class="space-y-1">
                                ${recommendations.map(rec => `
                                    <li class="text-sm text-gray-600 flex items-start">
                                        <span class="text-green-500 mr-2">•</span>
                                        ${rec}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    </script>
</body>
</html>